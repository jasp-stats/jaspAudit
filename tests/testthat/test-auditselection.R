context("[Audit] Selection")

### TEST 1: TAKING A MONETARY UNIT SAMPLE OF SIZE n = 200

options <- jaspTools::analysisOptions("auditSelection")
options$id <- "ID"
options$values <- "bookValue"
options$n <- 200
options$tableSample <- TRUE
options$export_sample <- FALSE
options$file <- ""
options$units <- "values"
options$sampling_method <- "interval"
options$name_indicator <- ""
set.seed(1)
results <- jaspTools::runAnalysis("auditSelection", "BuildIt_Monetary.csv", options)


test_that("<b>Table 2.</b> Information about Monetary Interval Selection results match", {
  table <- results[["results"]][["selectionContainer"]][["collection"]][["selectionContainer_tableInterval"]][["data"]]
  jaspTools::expect_equal_tables(
    table,
    list(
      3500, 1403221, 200, 200, "7.5%", "Total", 105247.58,
      0, 0, 0, 0, "0%", "Top stratum", 0, 3500, 1403220.82,
      200, 200, "7.5%", "Bottom stratum", 105247.58
    )
  )
})

test_that("<b>Table 3.</b> Raw Sample results match", {
  table <- results[["results"]][["selectionContainer"]][["collection"]][["selectionContainer_tableSample"]][["data"]]
  jaspTools::expect_equal_tables(
    table,
    list(
      82884, 1, 1, 242.61, 46163, 17, 1, 511.62, 57172, 38, 1, 329.3,
      86073, 55, 1, 874.46, 90160, 73, 1, 205.69, 31740, 89, 1, 735.45,
      4756, 110, 1, 295.96, 13081, 128, 1, 734.93, 90183, 146, 1,
      333.28, 76263, 162, 1, 701.99, 96080, 183, 1, 449.07, 96029,
      201, 1, 465.35, 11890, 218, 1, 296.31, 98624, 235, 1, 340.6,
      78992, 252, 1, 686.1, 96292, 269, 1, 179.32, 22629, 289, 1,
      488.41, 11569, 306, 1, 1025.03, 57791, 325, 1, 376, 15197, 344,
      1, 536.77, 20711, 358, 1, 610.88, 58735, 377, 1, 620.96, 75887,
      392, 1, 739, 497, 411, 1, 640.18, 24835, 430, 1, 237, 52055,
      449, 1, 879.91, 26364, 462, 1, 740.25, 71824, 479, 1, 305.14,
      8847, 497, 1, 397.11, 56756, 514, 1, 348.08, 61005, 536, 1,
      233.97, 44391, 554, 1, 374.93, 88214, 574, 1, 214.61, 16689,
      589, 1, 630.99, 27905, 606, 1, 868.59, 51619, 625, 1, 274.09,
      58370, 641, 1, 182.14, 47485, 660, 1, 773.14, 20237, 679, 1,
      669.75, 64305, 699, 1, 319.68, 99012, 715, 1, 313.75, 78676,
      735, 1, 346.28, 4261, 752, 1, 214.07, 47596, 771, 1, 256.13,
      72660, 795, 1, 366.19, 82711, 813, 1, 288.93, 80057, 828, 1,
      762.64, 35269, 850, 1, 281.84, 83339, 867, 1, 614.68, 93477,
      887, 1, 692.36, 98110, 902, 1, 617.6, 73208, 921, 1, 370.28,
      68039, 939, 1, 684.79, 99419, 956, 1, 668.93, 64369, 972, 1,
      382.49, 47424, 992, 1, 469.18, 92166, 1010, 1, 566.01, 83189,
      1031, 1, 199.8, 59197, 1050, 1, 796.94, 37569, 1068, 1, 633.59,
      65319, 1081, 1, 502.54, 85233, 1098, 1, 686.1, 28178, 1113,
      1, 367.64, 38019, 1132, 1, 537.14, 37412, 1150, 1, 306.66, 59189,
      1165, 1, 186.49, 10345, 1182, 1, 294.04, 90284, 1198, 1, 550.7,
      12827, 1214, 1, 688.28, 5324, 1233, 1, 503.95, 57764, 1249,
      1, 696.32, 6771, 1267, 1, 351.53, 45561, 1286, 1, 702.76, 60970,
      1301, 1, 348.48, 28529, 1317, 1, 471.97, 77871, 1335, 1, 812.13,
      19517, 1354, 1, 340.07, 8070, 1368, 1, 938.12, 83336, 1383,
      1, 656.34, 55381, 1402, 1, 900.38, 88454, 1421, 1, 856.28, 13214,
      1437, 1, 994.44, 60630, 1455, 1, 681.91, 83225, 1474, 1, 221.15,
      81443, 1492, 1, 543.8, 48139, 1505, 1, 718.58, 7652, 1518, 1,
      846.99, 36945, 1534, 1, 714.02, 4120, 1552, 1, 233.88, 26525,
      1572, 1, 941.47, 97834, 1590, 1, 294.9, 60760, 1606, 1, 715.14,
      98301, 1627, 1, 429.07, 6686, 1646, 1, 343.83, 39990, 1668,
      1, 788, 20736, 1685, 1, 407.24, 83784, 1702, 1, 389.55, 35982,
      1721, 1, 829.17, 24275, 1738, 1, 721.75, 10054, 1754, 1, 369.34,
      87258, 1774, 1, 157.68, 6154, 1791, 1, 285.42, 40471, 1808,
      1, 438.74, 65326, 1822, 1, 484.13, 37044, 1839, 1, 654.61, 78043,
      1858, 1, 664.6, 78011, 1877, 1, 583.89, 2885, 1895, 1, 285,
      94914, 1912, 1, 646.29, 27340, 1927, 1, 659.18, 98561, 1942,
      1, 294.24, 27256, 1958, 1, 314.22, 85588, 1976, 1, 535.51, 2740,
      1995, 1, 714.23, 5590, 2010, 1, 676.34, 21217, 2026, 1, 172.91,
      13683, 2041, 1, 381.64, 35189, 2058, 1, 337.29, 29742, 2075,
      1, 554.85, 89961, 2089, 1, 337.64, 48652, 2103, 1, 497.21, 99274,
      2118, 1, 816.62, 72040, 2135, 1, 509.04, 25056, 2149, 1, 344.4,
      16092, 2168, 1, 595.35, 39429, 2183, 1, 338.23, 87666, 2199,
      1, 544.79, 53398, 2220, 1, 448.74, 60413, 2238, 1, 418.78, 80386,
      2257, 1, 553.69, 60271, 2275, 1, 502.81, 34881, 2289, 1, 1041.99,
      93548, 2306, 1, 439.82, 432, 2324, 1, 593.65, 9063, 2340, 1,
      700.38, 1692, 2354, 1, 607.25, 49157, 2369, 1, 911.21, 23549,
      2389, 1, 718.86, 65112, 2403, 1, 408.75, 58501, 2420, 1, 386.36,
      37248, 2435, 1, 1041.44, 53304, 2452, 1, 346.7, 68187, 2470,
      1, 289.23, 72681, 2486, 1, 651.26, 78346, 2505, 1, 478.69, 37458,
      2522, 1, 554.27, 64553, 2540, 1, 432.18, 16188, 2558, 1, 649.78,
      23322, 2575, 1, 378.66, 76001, 2590, 1, 1230.94, 97083, 2605,
      1, 849.02, 95414, 2618, 1, 337.08, 32760, 2636, 1, 599.3, 39805,
      2656, 1, 617.63, 35420, 2679, 1, 320.63, 225, 2698, 1, 507.18,
      46509, 2719, 1, 353.72, 73254, 2736, 1, 343.81, 11585, 2755,
      1, 157.51, 98790, 2768, 1, 558.36, 10925, 2787, 1, 377.1, 67454,
      2806, 1, 218.2, 66041, 2824, 1, 684.86, 51035, 2843, 1, 337.96,
      58155, 2860, 1, 229.59, 76649, 2880, 1, 465.22, 71135, 2900,
      1, 334.26, 41792, 2920, 1, 202.58, 21214, 2941, 1, 430.11, 81544,
      2961, 1, 427.78, 99150, 2982, 1, 514.03, 74281, 2998, 1, 215.46,
      75272, 3014, 1, 510.93, 52121, 3029, 1, 993.57, 13359, 3047,
      1, 1262.85, 6080, 3064, 1, 722.45, 20335, 3082, 1, 564.01, 78336,
      3100, 1, 359.43, 31532, 3120, 1, 469, 72035, 3137, 1, 322.92,
      71832, 3152, 1, 1001.82, 77405, 3169, 1, 907.06, 67180, 3187,
      1, 254.39, 14754, 3205, 1, 212.81, 90783, 3222, 1, 543.95, 17096,
      3237, 1, 606.61, 89779, 3255, 1, 295.77, 61391, 3273, 1, 136.1,
      2111, 3292, 1, 215.07, 79729, 3313, 1, 882.54, 47872, 3330,
      1, 444.67, 85306, 3349, 1, 674.63, 15, 3368, 1, 475.92, 26052,
      3383, 1, 681.73, 99612, 3394, 1, 2244.4, 18796, 3409, 1, 414.75,
      70852, 3428, 1, 606.14, 54606, 3444, 1, 377.4, 53902, 3465,
      1, 400.3, 89394, 3483, 1, 698.2
    )
  )
})

test_that("<b>Table 1.</b> Selection Summary results match", {
  table <- results[["results"]][["selectionContainer"]][["collection"]][["selectionContainer_tableSelection"]][["data"]]
  jaspTools::expect_equal_tables(
    table,
    list("7.5%", 200, 200, 105247.58)
  )
})

### Test 2: Taking a record sample of n = 200 using ID only

options <- jaspTools::analysisOptions("auditSelection")
options$id <- "ID"
options$values <- "bookValue"
options$n <- 200
options$tableSample <- TRUE
options$export_sample <- FALSE
options$file <- ""
options$units <- "items"
options$sampling_method <- "random"
options$name_indicator <- ""
set.seed(1)
results <- jaspTools::runAnalysis("auditSelection", "BuildIt_Monetary.csv", options)


test_that("<b>Table 2.</b> Raw Sample results match", {
  table <- results[["results"]][["selectionContainer"]][["collection"]][["selectionContainer_tableSample"]][["data"]]
  jaspTools::expect_equal_tables(
    table,
    list(
      85674, 930, 1, 257.82, 83429, 1303, 1, 106.31, 36844, 2005, 1,
      272.96, 75319, 3179, 1, 414.35, 7246, 706, 1, 418.32, 21683,
      3145, 1, 475.98, 77480, 3307, 1, 182.85, 42056, 2313, 1, 266.6,
      61787, 2202, 1, 65.07, 47821, 217, 1, 52.75, 18869, 721, 1,
      280.47, 80241, 618, 1, 274.84, 23934, 2405, 1, 174.33, 73814,
      1345, 1, 638.57, 5783, 2695, 1, 214.13, 3751, 1742, 1, 293.93,
      27583, 2512, 1, 105.15, 40057, 3472, 1, 318.8, 63696, 1331,
      1, 346.54, 546, 2722, 1, 269.3, 88695, 3272, 1, 476.68, 91066,
      743, 1, 424.74, 92920, 2281, 1, 197.02, 985, 440, 1, 633.92,
      46994, 936, 1, 297.62, 93474, 1352, 1, 371.55, 53784, 47, 1,
      325.19, 26151, 1339, 1, 222.63, 32637, 3044, 1, 194.67, 37062,
      1192, 1, 603.58, 67886, 1688, 1, 422.12, 77292, 2099, 1, 349.68,
      57674, 1728, 1, 349.28, 96911, 652, 2, 652.39, 57115, 2896,
      1, 499.94, 9063, 2340, 1, 700.38, 4640, 2780, 1, 231.32, 33907,
      378, 1, 475.63, 47739, 2533, 1, 486.44, 43868, 1440, 1, 576.5,
      85855, 2874, 1, 447.9, 52635, 2265, 1, 439.56, 59274, 2741,
      1, 402.93, 73842, 1936, 1, 421.02, 27129, 1855, 1, 270.93, 7218,
      2763, 1, 420.53, 27241, 82, 1, 219.76, 7074, 1671, 1, 112.57,
      73936, 2564, 1, 1107.89, 82692, 2425, 1, 202.95, 53193, 1672,
      1, 362.19, 83758, 3015, 1, 154.38, 36945, 1534, 1, 714.02, 26870,
      857, 1, 346.21, 20102, 248, 1, 291.07, 73011, 349, 1, 513.16,
      56209, 1107, 1, 441.31, 5668, 1816, 1, 545.66, 11857, 2318,
      1, 360.57, 73509, 1424, 1, 266.04, 78182, 3196, 1, 407.17, 67675,
      1028, 1, 231.67, 12378, 1607, 1, 346.78, 32125, 1164, 1, 262.23,
      27002, 2279, 1, 408.25, 71277, 904, 1, 294.71, 65816, 1675,
      1, 321.77, 43422, 2683, 1, 561.68, 64172, 295, 1, 556.46, 6080,
      3064, 1, 722.45, 95137, 1187, 1, 324.5, 34452, 2939, 1, 309.78,
      12827, 1214, 1, 688.28, 38541, 1169, 1, 516.02, 39990, 1668,
      1, 788, 35955, 3123, 1, 98.42, 90807, 3026, 1, 595.88, 95475,
      1365, 1, 133.16, 84518, 2721, 1, 285.89, 24135, 3363, 1, 405.29,
      94689, 1522, 1, 840.28, 20307, 2494, 1, 478.7, 79305, 1400,
      1, 530.44, 17506, 1139, 1, 156.15, 63800, 2650, 1, 177.7, 66386,
      710, 1, 602.31, 55292, 2489, 1, 317.54, 10332, 426, 1, 337.79,
      9542, 860, 1, 785.95, 67148, 502, 1, 341.15, 25008, 839, 1,
      448.07, 96963, 207, 1, 745.64, 51156, 2249, 1, 154.55, 38896,
      3067, 1, 445.42, 34066, 2727, 1, 385.24, 16989, 2791, 1, 208.21,
      7569, 1594, 1, 241.57, 75139, 1436, 1, 181.02, 16324, 2839,
      1, 372.1, 99274, 2118, 1, 816.62, 20598, 2292, 1, 184.38, 73288,
      1237, 1, 891.39, 54895, 946, 1, 900.56, 92971, 3475, 1, 98.6,
      72706, 2218, 1, 169.46, 60942, 747, 1, 442.12, 20760, 453, 1,
      734.29, 58332, 1674, 1, 458.72, 48095, 3235, 1, 852.46, 23624,
      2096, 1, 876.04, 1563, 3417, 1, 239.77, 56996, 2562, 1, 599.29,
      57764, 1249, 1, 696.32, 17899, 1511, 1, 239.15, 75550, 519,
      1, 130.53, 25529, 46, 1, 464.7, 78346, 2505, 1, 478.69, 14846,
      362, 1, 350.91, 95723, 1562, 1, 242.12, 91121, 2241, 1, 459.71,
      85129, 1735, 1, 620.45, 53855, 1696, 1, 632.64, 54696, 608,
      1, 333.92, 49666, 2642, 1, 601.71, 87528, 1589, 1, 196.42, 49344,
      1790, 1, 319.8, 1570, 727, 1, 321.75, 5861, 801, 1, 186.49,
      16829, 2085, 1, 392.71, 78060, 2013, 1, 508.97, 82033, 270,
      1, 352.75, 67389, 125, 2, 283.38, 35996, 2250, 1, 153.27, 52977,
      3251, 1, 411.25, 49315, 2094, 1, 629.13, 92804, 1964, 1, 272.72,
      55567, 1842, 1, 518.98, 12959, 3448, 1, 296.82, 23651, 1777,
      1, 162.18, 82537, 2390, 1, 800.67, 92943, 2106, 1, 666.35, 60224,
      837, 1, 429.84, 49910, 2553, 1, 272.06, 77108, 1584, 1, 515.81,
      52317, 613, 1, 177.37, 37651, 2614, 1, 594.88, 65018, 368, 1,
      309.25, 4911, 2152, 1, 261.76, 27769, 1951, 1, 425.57, 27232,
      1151, 1, 306.77, 98342, 1586, 1, 155.36, 93244, 1752, 1, 470.64,
      92541, 634, 1, 244.31, 60750, 1854, 1, 247.16, 92751, 264, 2,
      500.51, 12210, 973, 1, 330.11, 49650, 745, 1, 831.95, 64492,
      997, 1, 232.65, 5732, 3133, 1, 599.42, 81023, 2730, 1, 359.4,
      16896, 3083, 1, 491.14, 79159, 1446, 1, 358.62, 10375, 224,
      1, 746.81, 52861, 1175, 1, 107.99, 95715, 2534, 1, 457.42, 10345,
      1182, 1, 294.04, 74725, 2207, 1, 446.75, 87073, 2943, 1, 287,
      51717, 2997, 1, 98.78, 2162, 1370, 1, 256.01, 30593, 1332, 1,
      278.41, 79478, 3135, 1, 544.8, 4647, 2256, 1, 698.37, 67772,
      2594, 1, 662.55, 7603, 2119, 1, 409.08, 70401, 3161, 1, 456.7,
      13270, 1029, 1, 589.24, 82675, 670, 1, 383.78, 62406, 3103,
      1, 627.74, 93260, 1762, 1, 406.67, 32190, 3070, 1, 596.3, 21503,
      663, 1, 104.32, 50713, 2654, 1, 201.09, 94242, 2536, 1, 364.22,
      77635, 3304, 1, 346.41, 20537, 1917, 1, 564.49, 9890, 2492,
      1, 367.68, 79072, 1362, 1, 338.12, 68114, 354, 1, 246.06, 85051,
      3246, 2, 228.68, 47424, 992, 1, 469.18, 7017, 2068, 1, 373.5,
      50787, 387, 1, 173.28, 38318, 2942, 1, 303.36, 28178, 1113,
      1, 367.64, 35995, 2740, 1, 630.45
    )
  )
})

test_that("<b>Table 1.</b> Selection Summary results match", {
  table <- results[["results"]][["selectionContainer"]][["collection"]][["selectionContainer_tableSelection"]][["data"]]
  jaspTools::expect_equal_tables(
    table,
    list("5.71%", 196, 200)
  )
})

### Test 3: Selection using auditRattle.csv data set

options <- jaspTools::analysisOptions("auditSelection")
options$id <- "ID"
options$values <- "Deductions"
options$n <- 40
options$tableDescriptives <- TRUE
options$tableSample <- TRUE
options$export_sample <- FALSE
options$file <- ""
options$units <- "values"
options$sampling_method <- "random"
options$name_indicator <- ""
set.seed(1)
results <- jaspTools::runAnalysis("auditSelection", "auditRattle.csv", options)


test_that("<b>Table 2.</b> Descriptive Statistics for Sample results match", {
  table <- results[["results"]][["selectionContainer"]][["collection"]][["selectionContainer_tableDescriptives"]][["data"]]
  jaspTools::expect_equal_tables(
    table,
    list(
      32, "Items", 32, 2904, 1704.10416666667, 1708, 893.333333333333,
      "Deductions", 2010.66666666667, 495.757741143016, 245775.737903225
    )
  )
})

test_that("<b>Table 3.</b> Raw Sample results match", {
  table <- results[["results"]][["selectionContainer"]][["collection"]][["selectionContainer_tableSample"]][["data"]]
  jaspTools::expect_equal_tables(
    table,
    list(
      1977, 29, 29, 1, 1902, 60, 60, 1, 1848, 59, 59, 1, 1112.66666666667,
      80, 80, 1, 2174, 8, 8, 1, 1114.66666666667, 37, 37, 1, 1060,
      23, 23, 2, 1564, 27, 27, 2, 1568, 36, 36, 1, 2415, 16, 16, 1,
      2246, 55, 55, 1, 1511.33333333333, 26, 26, 1, 1902, 73, 73,
      1, 1320, 56, 56, 1, 1887, 61, 61, 1, 1492, 69, 69, 1, 893.333333333333,
      57, 57, 1, 1320, 12, 12, 1, 1068, 77, 77, 1, 2392, 49, 49, 1,
      2904, 65, 65, 1, 1114.66666666667, 52, 52, 1, 1977, 32, 32,
      2, 1902, 4, 4, 1, 1848, 75, 75, 1, 2246, 1, 1, 1, 1160.66666666667,
      20, 20, 1, 1559.33333333333, 68, 68, 4, 1250.66666666667, 62,
      62, 1, 2415, 48, 48, 1, 1485, 51, 51, 3, 1902, 38, 38, 1
    )
  )
})

test_that("<b>Table 1.</b> Selection Summary results match", {
  table <- results[["results"]][["selectionContainer"]][["collection"]][["selectionContainer_tableSelection"]][["data"]]
  jaspTools::expect_equal_tables(
    table,
    list("40.35%", 32, 40, 54531.3333333333)
  )
})
