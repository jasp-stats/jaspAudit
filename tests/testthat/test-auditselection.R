context("[Audit] Selection")

### TEST 1: TAKING A MONETARY UNIT SAMPLE OF SIZE n = 200

options <- jaspTools::analysisOptions("auditSelection")
options$id <- "ID"
options$values <- "bookValue"
options$n <- 200
options$explanatoryText <- TRUE
options$tableSample <- TRUE
options$export_sample <- FALSE
options$file <- ""
options$units <- "values"
options$sampling_method <- "interval"
options$startMethod <- "fixedStart"
options$randomize <- FALSE
options$rank <- ""
options$tableDescriptives <- FALSE
options$start <- 1
options$name_indicator <- ""
options$seed <- 1
set.seed(1)
results <- jaspTools::runAnalysis("auditSelection", "BuildIt_Monetary.csv", options)


test_that("<b>Table 2.</b> Information about Monetary Interval Selection results match", {
  table <- results[["results"]][["selectionContainer"]][["collection"]][["selectionContainer_tableInterval"]][["data"]]
  jaspTools::expect_equal_tables(
    table,
    list(
      3500, 1403221, 200, 200, "7.5%", "Total", 105247.58,
      0, 0, 0, 0, "0%", "Top stratum", 0, 3500, 1403220.82,
      200, 200, "7.5%", "Bottom stratum", 105247.58
    )
  )
})

test_that("<b>Table 3.</b> Selected Items results match", {
  table <- results[["results"]][["selectionContainer"]][["collection"]][["selectionContainer_tableSample"]][["data"]]
  jaspTools::expect_equal_tables(
    table,
    list(
      82884, 1, 1, 242.61, 46163, 17, 1, 511.62, 57172, 38, 1, 329.3,
      86073, 55, 1, 874.46, 90160, 73, 1, 205.69, 31740, 89, 1, 735.45,
      4756, 110, 1, 295.96, 13081, 128, 1, 734.93, 90183, 146, 1,
      333.28, 76263, 162, 1, 701.99, 96080, 183, 1, 449.07, 96029,
      201, 1, 465.35, 11890, 218, 1, 296.31, 98624, 235, 1, 340.6,
      78992, 252, 1, 686.1, 96292, 269, 1, 179.32, 22629, 289, 1,
      488.41, 11569, 306, 1, 1025.03, 57791, 325, 1, 376, 15197, 344,
      1, 536.77, 20711, 358, 1, 610.88, 58735, 377, 1, 620.96, 75887,
      392, 1, 739, 497, 411, 1, 640.18, 24835, 430, 1, 237, 52055,
      449, 1, 879.91, 26364, 462, 1, 740.25, 71824, 479, 1, 305.14,
      8847, 497, 1, 397.11, 56756, 514, 1, 348.08, 61005, 536, 1,
      233.97, 44391, 554, 1, 374.93, 88214, 574, 1, 214.61, 16689,
      589, 1, 630.99, 27905, 606, 1, 868.59, 51619, 625, 1, 274.09,
      58370, 641, 1, 182.14, 47485, 660, 1, 773.14, 20237, 679, 1,
      669.75, 64305, 699, 1, 319.68, 99012, 715, 1, 313.75, 78676,
      735, 1, 346.28, 4261, 752, 1, 214.07, 47596, 771, 1, 256.13,
      72660, 795, 1, 366.19, 82711, 813, 1, 288.93, 80057, 828, 1,
      762.64, 35269, 850, 1, 281.84, 83339, 867, 1, 614.68, 93477,
      887, 1, 692.36, 98110, 902, 1, 617.6, 73208, 921, 1, 370.28,
      68039, 939, 1, 684.79, 99419, 956, 1, 668.93, 64369, 972, 1,
      382.49, 47424, 992, 1, 469.18, 92166, 1010, 1, 566.01, 83189,
      1031, 1, 199.8, 59197, 1050, 1, 796.94, 37569, 1068, 1, 633.59,
      65319, 1081, 1, 502.54, 85233, 1098, 1, 686.1, 28178, 1113,
      1, 367.64, 38019, 1132, 1, 537.14, 37412, 1150, 1, 306.66, 59189,
      1165, 1, 186.49, 10345, 1182, 1, 294.04, 90284, 1198, 1, 550.7,
      12827, 1214, 1, 688.28, 5324, 1233, 1, 503.95, 57764, 1249,
      1, 696.32, 6771, 1267, 1, 351.53, 45561, 1286, 1, 702.76, 60970,
      1301, 1, 348.48, 28529, 1317, 1, 471.97, 77871, 1335, 1, 812.13,
      19517, 1354, 1, 340.07, 8070, 1368, 1, 938.12, 83336, 1383,
      1, 656.34, 55381, 1402, 1, 900.38, 88454, 1421, 1, 856.28, 13214,
      1437, 1, 994.44, 60630, 1455, 1, 681.91, 83225, 1474, 1, 221.15,
      81443, 1492, 1, 543.8, 48139, 1505, 1, 718.58, 7652, 1518, 1,
      846.99, 36945, 1534, 1, 714.02, 4120, 1552, 1, 233.88, 26525,
      1572, 1, 941.47, 97834, 1590, 1, 294.9, 60760, 1606, 1, 715.14,
      98301, 1627, 1, 429.07, 6686, 1646, 1, 343.83, 39990, 1668,
      1, 788, 20736, 1685, 1, 407.24, 83784, 1702, 1, 389.55, 35982,
      1721, 1, 829.17, 24275, 1738, 1, 721.75, 10054, 1754, 1, 369.34,
      87258, 1774, 1, 157.68, 6154, 1791, 1, 285.42, 40471, 1808,
      1, 438.74, 65326, 1822, 1, 484.13, 37044, 1839, 1, 654.61, 78043,
      1858, 1, 664.6, 78011, 1877, 1, 583.89, 2885, 1895, 1, 285,
      94914, 1912, 1, 646.29, 27340, 1927, 1, 659.18, 98561, 1942,
      1, 294.24, 27256, 1958, 1, 314.22, 85588, 1976, 1, 535.51, 2740,
      1995, 1, 714.23, 5590, 2010, 1, 676.34, 21217, 2026, 1, 172.91,
      13683, 2041, 1, 381.64, 35189, 2058, 1, 337.29, 29742, 2075,
      1, 554.85, 89961, 2089, 1, 337.64, 48652, 2103, 1, 497.21, 99274,
      2118, 1, 816.62, 72040, 2135, 1, 509.04, 25056, 2149, 1, 344.4,
      16092, 2168, 1, 595.35, 39429, 2183, 1, 338.23, 87666, 2199,
      1, 544.79, 53398, 2220, 1, 448.74, 60413, 2238, 1, 418.78, 80386,
      2257, 1, 553.69, 60271, 2275, 1, 502.81, 34881, 2289, 1, 1041.99,
      93548, 2306, 1, 439.82, 432, 2324, 1, 593.65, 9063, 2340, 1,
      700.38, 1692, 2354, 1, 607.25, 49157, 2369, 1, 911.21, 23549,
      2389, 1, 718.86, 65112, 2403, 1, 408.75, 58501, 2420, 1, 386.36,
      37248, 2435, 1, 1041.44, 53304, 2452, 1, 346.7, 68187, 2470,
      1, 289.23, 72681, 2486, 1, 651.26, 78346, 2505, 1, 478.69, 37458,
      2522, 1, 554.27, 64553, 2540, 1, 432.18, 16188, 2558, 1, 649.78,
      23322, 2575, 1, 378.66, 76001, 2590, 1, 1230.94, 97083, 2605,
      1, 849.02, 95414, 2618, 1, 337.08, 32760, 2636, 1, 599.3, 39805,
      2656, 1, 617.63, 35420, 2679, 1, 320.63, 225, 2698, 1, 507.18,
      46509, 2719, 1, 353.72, 73254, 2736, 1, 343.81, 11585, 2755,
      1, 157.51, 98790, 2768, 1, 558.36, 10925, 2787, 1, 377.1, 67454,
      2806, 1, 218.2, 66041, 2824, 1, 684.86, 51035, 2843, 1, 337.96,
      58155, 2860, 1, 229.59, 76649, 2880, 1, 465.22, 71135, 2900,
      1, 334.26, 41792, 2920, 1, 202.58, 21214, 2941, 1, 430.11, 81544,
      2961, 1, 427.78, 99150, 2982, 1, 514.03, 74281, 2998, 1, 215.46,
      75272, 3014, 1, 510.93, 52121, 3029, 1, 993.57, 13359, 3047,
      1, 1262.85, 6080, 3064, 1, 722.45, 20335, 3082, 1, 564.01, 78336,
      3100, 1, 359.43, 31532, 3120, 1, 469, 72035, 3137, 1, 322.92,
      71832, 3152, 1, 1001.82, 77405, 3169, 1, 907.06, 67180, 3187,
      1, 254.39, 14754, 3205, 1, 212.81, 90783, 3222, 1, 543.95, 17096,
      3237, 1, 606.61, 89779, 3255, 1, 295.77, 61391, 3273, 1, 136.1,
      2111, 3292, 1, 215.07, 79729, 3313, 1, 882.54, 47872, 3330,
      1, 444.67, 85306, 3349, 1, 674.63, 15, 3368, 1, 475.92, 26052,
      3383, 1, 681.73, 99612, 3394, 1, 2244.4, 18796, 3409, 1, 414.75,
      70852, 3428, 1, 606.14, 54606, 3444, 1, 377.4, 53902, 3465,
      1, 400.3, 89394, 3483, 1, 698.2
    )
  )
})

test_that("<b>Table 1.</b> Selection Summary results match", {
  table <- results[["results"]][["selectionContainer"]][["collection"]][["selectionContainer_tableSelection"]][["data"]]
  jaspTools::expect_equal_tables(
    table,
    list("7.5%", 200, 200, 105247.58)
  )
})

### Test 2: Taking a record sample of n = 200 using ID only

options <- jaspTools::analysisOptions("auditSelection")
options$id <- "ID"
options$values <- "bookValue"
options$n <- 200
options$explanatoryText <- TRUE
options$tableSample <- TRUE
options$tableDescriptives <- FALSE
options$export_sample <- FALSE
options$randomize <- FALSE
options$file <- ""
options$rank <- ""
options$units <- "items"
options$sampling_method <- "random"
options$name_indicator <- ""
options$seed <- 1
set.seed(1)
results <- jaspTools::runAnalysis("auditSelection", "BuildIt_Monetary.csv", options)


test_that("<b>Table 2.</b> Selected Items results match", {
  table <- results[["results"]][["selectionContainer"]][["collection"]][["selectionContainer_tableSample"]][["data"]]
  jaspTools::expect_equal_tables(
    table,
    list(
      85674, 930, 1, 257.82, 83429, 1303, 1, 106.31, 70246, 2004, 1,
      316.38, 45736, 3177, 1, 169.97, 7246, 706, 1, 418.32, 5964,
      3140, 1, 191.77, 10934, 3301, 1, 239.7, 12499, 2309, 1, 282.66,
      48009, 2197, 1, 931.1, 55391, 216, 1, 593.38, 64893, 719, 1,
      234.73, 58475, 617, 1, 169.9, 84079, 2397, 1, 251.88, 754, 1340,
      1, 395.82, 67078, 2684, 1, 111.24, 85129, 1735, 1, 620.45, 82438,
      2501, 1, 481.47, 35945, 3455, 1, 274.93, 85806, 1324, 1, 200.7,
      1832, 2707, 1, 141.72, 39179, 3253, 1, 400.74, 72671, 739, 1,
      533.56, 67488, 2267, 1, 454.31, 11649, 437, 1, 505.37, 38549,
      929, 1, 336.55, 71371, 1342, 1, 688.71, 53784, 47, 1, 325.19,
      32940, 1329, 1, 388.31, 8716, 3020, 1, 450.76, 10345, 1182,
      1, 294.04, 1679, 1673, 1, 646.61, 4632, 2080, 1, 443.93, 44122,
      1712, 1, 401, 40763, 646, 1, 800.81, 49057, 2868, 1, 543.32,
      82429, 2317, 1, 278.87, 77998, 2752, 1, 143.73, 14869, 374,
      1, 344.8, 13137, 2506, 1, 160.23, 73509, 1424, 1, 266.04, 4480,
      2841, 1, 216.25, 44352, 2239, 1, 503.21, 83149, 2708, 1, 322.17,
      94914, 1912, 1, 646.29, 59661, 1831, 1, 190.45, 77138, 2728,
      1, 385.39, 18890, 81, 1, 511.56, 79250, 1648, 1, 347.55, 76399,
      2528, 1, 469.06, 22064, 2391, 1, 512.02, 26455, 3453, 1, 318.77,
      6808, 2971, 1, 217.15, 17899, 1511, 1, 239.15, 43678, 844, 1,
      459.47, 63863, 244, 1, 710.14, 10991, 343, 1, 133.92, 77111,
      1090, 1, 650.75, 14140, 1786, 1, 775.99, 27002, 2279, 1, 408.25,
      79305, 1400, 1, 530.44, 71279, 3141, 1, 132.79, 92166, 1010,
      1, 566.01, 62317, 1579, 1, 309.74, 67749, 1143, 1, 333.07, 50692,
      2237, 1, 381.26, 93477, 887, 1, 692.36, 28997, 1644, 1, 300.1,
      72195, 2631, 1, 885.24, 4913, 290, 1, 464.32, 28658, 3004, 1,
      108.78, 32125, 1164, 1, 262.23, 93251, 2879, 1, 238.91, 50469,
      1189, 1, 443.33, 85213, 1144, 1, 321.78, 85405, 1632, 1, 576.76,
      86317, 3056, 1, 246.22, 42536, 2960, 1, 472.47, 77871, 1335,
      1, 812.13, 23927, 2660, 1, 454.81, 70312, 3287, 1, 135.71, 45542,
      1487, 1, 339.63, 99028, 2437, 1, 336.35, 8070, 1368, 1, 938.12,
      69483, 1112, 1, 249.75, 85471, 2587, 1, 330.43, 52164, 693,
      1, 395.91, 92106, 2428, 1, 209.3, 26163, 416, 1, 270.58, 43352,
      838, 1, 188.72, 14139, 489, 1, 157.98, 45922, 818, 1, 1225.78,
      96029, 201, 1, 465.35, 42699, 2189, 1, 266.45, 47090, 2986,
      1, 368.51, 17218, 2653, 1, 590.33, 77455, 2715, 1, 98.22, 54,
      1550, 1, 296.07, 25836, 1396, 1, 314.19, 16442, 2759, 1, 596.34,
      35189, 2058, 1, 337.29, 86909, 2227, 1, 399.8, 13669, 1201,
      1, 244.48, 75063, 919, 1, 629.91, 450, 3373, 1, 789.05, 4911,
      2152, 1, 261.76, 1000, 724, 1, 298.96, 985, 440, 1, 633.92,
      47899, 1623, 1, 103.86, 79478, 3135, 1, 544.8, 91278, 2031,
      1, 389.86, 72546, 3310, 1, 288.69, 27786, 2481, 1, 582.91, 5434,
      1209, 1, 430.5, 75782, 1462, 1, 100.39, 67148, 502, 1, 341.15,
      32267, 45, 1, 318.45, 7886, 2422, 1, 733.21, 13682, 350, 1,
      441.66, 58, 1510, 1, 412.04, 46940, 2165, 1, 431.74, 13965,
      3353, 1, 281.28, 65816, 1675, 1, 321.77, 8383, 1637, 1, 215.13,
      16836, 586, 1, 571.22, 60214, 2549, 1, 627.62, 82902, 1532,
      1, 583.95, 3954, 1725, 1, 327.28, 65772, 701, 1, 538.94, 8596,
      772, 1, 50.53, 2933, 2009, 1, 517.89, 35525, 1938, 1, 366.94,
      14001, 260, 1, 524.19, 8083, 120, 1, 332.17, 31200, 3381, 1,
      741.53, 31873, 3126, 1, 352.27, 78060, 2013, 1, 508.97, 57162,
      1887, 1, 188.85, 14678, 1770, 1, 268.94, 16249, 3312, 1, 267.06,
      85734, 1707, 1, 337.15, 34895, 2295, 1, 371.89, 77179, 2021,
      1, 706, 91330, 803, 1, 304.58, 83339, 867, 1, 614.68, 42192,
      2448, 1, 409.64, 49287, 1519, 1, 232.96, 41417, 588, 1, 251.22,
      68151, 2504, 1, 464.06, 94854, 352, 1, 141.08, 12845, 2898,
      1, 253.63, 72231, 2060, 1, 423.53, 74600, 1866, 1, 434.29, 52815,
      1101, 1, 615.21, 86084, 1517, 1, 461.74, 85322, 3379, 1, 330.24,
      19938, 605, 1, 544.16, 71607, 1772, 1, 540.71, 78992, 252, 1,
      686.1, 51209, 3476, 1, 323.72, 79101, 711, 1, 832.79, 46089,
      952, 1, 147.54, 83073, 2989, 1, 652.79, 40983, 1490, 1, 477.78,
      42016, 2603, 1, 515.66, 45941, 2938, 1, 311.63, 2046, 1378,
      1, 202.89, 40051, 213, 1, 271.97, 96557, 1119, 1, 610.25, 42588,
      2412, 1, 340.33, 17785, 1125, 1, 112.01, 90852, 2100, 1, 244.36,
      11974, 2799, 1, 293.67, 2569, 2850, 1, 191.25, 86390, 3499,
      1, 328.26, 52022, 1266, 1, 380.99, 63071, 2978, 1, 563.3, 53527,
      2142, 1, 473.05, 7396, 2463, 1, 596.74, 50165, 2011, 1, 846.39,
      44268, 3000, 1, 298.12, 31284, 976, 1, 430.48, 8709, 635, 1,
      767.78, 38318, 2942, 1, 303.36, 91213, 1670, 1, 152.57, 97156,
      2909, 1, 370.44, 24203, 628, 1, 365.32, 71123, 2513, 1, 304.56,
      54631, 2401, 1, 192.73, 37735, 3366, 1, 304.21, 6468, 1814,
      1, 509.42, 77844, 2356, 1, 362.98, 90736, 1287, 1, 417.39, 59766,
      334, 1, 173.76, 38896, 3067, 1, 445.42, 25683, 937, 1, 276.45,
      94787, 1952, 1, 257.39, 85828, 365, 1, 488.64, 67231, 2777,
      1, 259.99, 59197, 1050, 1, 796.94, 53213, 2585, 1, 592.87
    )
  )
})

test_that("<b>Table 1.</b> Selection Summary results match", {
  table <- results[["results"]][["selectionContainer"]][["collection"]][["selectionContainer_tableSelection"]][["data"]]
  jaspTools::expect_equal_tables(
    table,
    list(200, "5.71%", 200)
  )
})

### Test 3: Selection using auditRattle.csv data set

options <- jaspTools::analysisOptions("auditSelection")
options$id <- "ID"
options$values <- "Deductions"
options$explanatoryText <- TRUE
options$n <- 40
options$tableDescriptives <- TRUE
options$randomize <- FALSE
options$tableSample <- TRUE
options$units <- "values"
options$sampling_method <- "random"
options$file <- ""
options$rank <- ""
options$name_indicator <- ""
options$seed <- 1
set.seed(1)
results <- jaspTools::runAnalysis("auditSelection", "auditRattle.csv", options)


test_that("<b>Table 2.</b> Descriptive Statistics for Sample results match", {
  table <- results[["results"]][["selectionContainer"]][["collection"]][["selectionContainer_tableDescriptives"]][["data"]]
  jaspTools::expect_equal_tables(
    table,
    list(
      32, "Items", 32, 2904, 1704.10416666667, 1708, 893.333333333333,
      "Deductions", 2010.66666666667, 495.757741143016, 245775.737903225
    )
  )
})

test_that("<b>Table 3.</b> Selected Items results match", {
  table <- results[["results"]][["selectionContainer"]][["collection"]][["selectionContainer_tableSample"]][["data"]]
  jaspTools::expect_equal_tables(
    table,
    list(
      1977, 29, 29, 2, 1902, 60, 60, 1, 1848, 59, 59, 1, 1112.66666666667,
      80, 80, 1, 2174, 8, 8, 3, 1114.66666666667, 37, 37, 1, 1060,
      23, 23, 1, 1564, 27, 27, 2, 1568, 36, 36, 1, 2415, 16, 16, 1,
      2246, 55, 55, 1, 1511.33333333333, 26, 26, 1, 1902, 73, 73,
      4, 1320, 56, 56, 1, 1887, 61, 61, 2, 1492, 69, 69, 1, 893.333333333333,
      57, 57, 1, 1320, 12, 12, 1, 1068, 77, 77, 1, 2392, 49, 49, 1,
      2904, 65, 65, 1, 1114.66666666667, 52, 52, 1, 1977, 32, 32,
      1, 1902, 4, 4, 1, 1848, 75, 75, 1, 2246, 1, 1, 1, 1160.66666666667,
      20, 20, 1, 1559.33333333333, 68, 68, 1, 1250.66666666667, 62,
      62, 1, 2415, 48, 48, 1, 1485, 51, 51, 1, 1902, 38, 38, 1
    )
  )
})

test_that("<b>Table 1.</b> Selection Summary results match", {
  table <- results[["results"]][["selectionContainer"]][["collection"]][["selectionContainer_tableSelection"]][["data"]]
  jaspTools::expect_equal_tables(
    table,
    list(32, "40.35%", 40, 54531.3333333333)
  )
})
